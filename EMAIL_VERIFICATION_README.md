# Система подтверждения email для QuizCard

## Описание

Система обеспечивает безопасную верификацию email адресов преподавателей при регистрации в системе QuizCard.

## Установка и настройка

### 1. Выполнение миграции базы данных

Запустите в браузере скрипт настройки:

```
http://ваш-домен.com/database/email_verification_setup.php
```

### 2. Настройка email конфигурации

Отредактируйте файл `config/email_config.php`:

- Укажите правильный email отправителя
- Настройте домен для корректных ссылок
- При необходимости измените лимиты отправки

### 3. Настройка cron для очистки токенов (рекомендуется)

Добавьте в crontab следующую задачу для ежедневной очистки истекших токенов:

```bash
# Очистка истекших токенов email верификации (каждый день в 02:00)
0 2 * * * /usr/bin/php /path/to/your/project/cleanup_email_tokens.php >/dev/null 2>&1

# Или через wget/curl если PHP CLI недоступен
0 2 * * * /usr/bin/wget -q -O /dev/null http://ваш-домен.com/cleanup_email_tokens.php

# Альтернативно с curl
0 2 * * * /usr/bin/curl -s http://ваш-домен.com/cleanup_email_tokens.php >/dev/null 2>&1
```

## Как это работает

### Процесс регистрации

1. Преподаватель заполняет форму регистрации с обязательным email
2. Система создает аккаунт со статусом `email_verified = 0`
3. Генерируется криптографически стойкий токен верификации
4. Отправляется красивое HTML письмо с ссылкой подтверждения
5. Преподаватель не может войти в систему до подтверждения email

### Процесс верификации

1. Преподаватель переходит по ссылке из письма
2. Система проверяет токен и срок его действия (24 часа)
3. При успешной проверке: `email_verified = 1`, токен удаляется
4. Преподаватель перенаправляется на страницу входа

### Защита от злоупотреблений

- Лимит повторной отправки: 5 минут между письмами
- Лимит попыток в день: 5 писем на пользователя
- Токены действуют только 24 часа
- Логирование всех операций

## Файлы системы

### Основные файлы

- `config/email_config.php` - конфигурация email
- `classes/User.php` - расширен методами верификации
- `verify_email.php` - обработка подтверждения
- `email_verification_required.php` - уведомление пользователя

### Скрипты установки

- `database/email_verification_setup.php` - миграция БД
- `database/rollback_email_verification.php` - откат изменений
- `cleanup_email_tokens.php` - очистка истекших токенов

### Переводы

Добавлены ключи переводов для всех языков:

- `includes/lang/ru.php`
- `includes/lang/en.php`
- `includes/lang/kk.php`

## API методы

### Класс User - новые методы

- `generateVerificationToken()` - генерация токена
- `sendVerificationEmail($email, $user_id)` - отправка письма
- `verifyEmail($token)` - подтверждение email
- `isEmailVerified($user_id)` - проверка статуса
- `resendVerificationEmail($user_id)` - повторная отправка

### Класс EmailConfig - утилиты

- `canSendEmail($user_id, $db)` - проверка лимитов
- `cleanupExpiredTokens($db)` - очистка токенов
- `logEmailSent($user_id, $email, $token, $db)` - логирование

## База данных

### Новые поля в таблице users

- `email_verified` TINYINT(1) DEFAULT 0 - статус подтверждения
- `verification_token` VARCHAR(255) NULL - токен верификации
- `verification_token_expires` DATETIME NULL - срок действия токена
- `last_verification_sent` DATETIME NULL - время последней отправки

### Новая таблица email_verification_logs

Логирование всех операций с email для отладки и статистики.

## Многоязычность

Система полностью поддерживает переключение языков:

- Письма отправляются на языке пользователя
- Все уведомления переведены
- Страницы верификации поддерживают все языки

## Безопасность

### Защита от спама

- Проверка IP адреса при запуске миграций
- Лимиты на отправку писем
- Логирование подозрительных действий

### Защита токенов

- Криптографически стойкие токены (64 символа hex)
- Ограниченный срок действия
- Одноразовое использование
- Автоматическая очистка

## Устранение неполадок

### Письма не приходят

1. Проверьте настройки `config/email_config.php`
2. Убедитесь, что функция `mail()` работает на сервере
3. Проверьте логи в `logs/email_cleanup.log`
4. Проверьте таблицу `email_verification_logs`

### Ошибки верификации

1. Проверьте, что поля БД созданы корректно
2. Убедитесь, что токены не истекли
3. Проверьте правильность ссылок в письмах

### Производительность

- Регулярно запускайте очистку токенов
- Мониторьте размер таблицы логов
- При необходимости архивируйте старые логи

## Тестирование

### Тестирование регистрации

1. Зарегистрируйте тестового преподавателя
2. Проверьте получение письма
3. Пройдите по ссылке подтверждения
4. Убедитесь в успешном входе

### Тестирование лимитов

1. Попробуйте отправить письмо несколько раз подряд
2. Убедитесь в работе лимита по времени
3. Проверьте дневной лимит отправки

## Поддержка

При возникновении проблем:

1. Проверьте логи системы
2. Запустите диагностику через `cleanup_email_tokens.php`
3. Проверьте настройки email на сервере
4. Убедитесь в корректности миграции БД

---

© 2025 QuizCard - Система изучения слов с флеш-карточками
