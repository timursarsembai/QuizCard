# Система валидации изображений QuizCard

## Обзор

Система валидации изображений обеспечивает безопасную и контролируемую загрузку изображений для словарных карточек в приложении QuizCard.

## Ограничения

### Размер файла

- **Максимальный размер:** 5MB
- Ограничение применяется как на серверной, так и на клиентской стороне

### Форматы файлов

- **Разрешенные форматы:** JPG, JPEG, PNG, GIF, WebP
- Проверка выполняется по расширению файла и MIME-типу

### Безопасность

- Проверка MIME-типа через `finfo_file()`
- Валидация через `getimagesize()` для подтверждения, что файл является изображением
- Уникальные имена файлов для предотвращения конфликтов

## Файлы системы

### Основные файлы

1. **`config/upload_config.php`** - Центральная конфигурация

   - Класс `UploadConfig` с константами и методами валидации
   - Централизованное управление настройками загрузки

2. **`teacher/vocabulary.php`** - Основной интерфейс загрузки

   - Форма добавления новых слов с изображениями
   - Модальное окно для изменения изображений
   - Клиентская и серверная валидация

3. **`teacher/import_words.php`** - Импорт с изображениями
   - Поддержка URL-адресов изображений
   - Поддержка base64-кодированных изображений
   - Валидация импортируемых изображений

### Языковые файлы

Добавлены ключи переводов в:

- `includes/lang/ru.php` - Русский язык
- `includes/lang/en.php` - Английский язык
- `includes/lang/kk.php` - Казахский язык

## Конфигурация

### Настройки в `UploadConfig`

```php
// Максимальный размер файла (5MB)
const VOCABULARY_IMAGE_MAX_SIZE = 5 * 1024 * 1024;

// Разрешенные расширения
const VOCABULARY_IMAGE_ALLOWED_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif', 'webp'];

// Разрешенные MIME-типы
const VOCABULARY_IMAGE_ALLOWED_MIME_TYPES = [
    'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'
];

// Пути для загрузки
const VOCABULARY_UPLOAD_DIR = '../uploads/vocabulary/';
const VOCABULARY_UPLOAD_PATH = 'uploads/vocabulary/';
```

## Валидация

### Серверная валидация

Выполняется через `UploadConfig::validateVocabularyImage()`:

1. **Проверка размера:** Файл не должен превышать 5MB
2. **Проверка расширения:** Только разрешенные форматы
3. **Проверка MIME-типа:** Дополнительная проверка безопасности
4. **Проверка валидности изображения:** Через `getimagesize()`

### Клиентская валидация (JavaScript)

```javascript
function validateImageFile(file) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  const allowedTypes = [
    "image/jpeg",
    "image/jpg",
    "image/png",
    "image/gif",
    "image/webp",
  ];

  // Проверки размера и типа файла
}
```

## Использование

### Добавление нового слова с изображением

1. Пользователь выбирает файл изображения
2. Клиентская валидация проверяет размер и тип
3. При отправке формы серверная валидация повторно проверяет файл
4. Файл сохраняется с уникальным именем
5. Путь к файлу сохраняется в базе данных

### Изменение изображения существующего слова

1. Пользователь нажимает на изображение или кнопку "Добавить фото"
2. Открывается модальное окно с формой загрузки
3. Валидация и сохранение работают аналогично добавлению нового слова
4. Старое изображение автоматически удаляется

### Импорт слов с изображениями

Поддерживаются два формата:

1. **URL изображений:** Система скачивает изображение и валидирует его
2. **Base64 данные:** Декодирование и валидация встроенных изображений

## Сообщения об ошибках

Все сообщения об ошибках локализованы и поддерживают три языка:

- `image_max_size_error` - Превышение размера файла
- `image_format_error` - Недопустимый формат
- `image_mime_type_error` - Неверный MIME-тип
- `image_invalid_error` - Файл не является изображением
- `image_upload_error` - Ошибка загрузки
- `image_directory_error` - Ошибка создания директории

## Тестирование

Создан файл `teacher/test_upload_config.php` для проверки:

- Настроек конфигурации
- Функций валидации
- Настроек PHP для загрузки файлов

**Примечание:** Тестовый файл можно удалить после проверки работоспособности.

## Рекомендации

1. **Настройки PHP:** Убедитесь, что настройки PHP позволяют загрузку файлов нужного размера:

   ```ini
   upload_max_filesize = 10M
   post_max_size = 10M
   max_file_uploads = 20
   ```

2. **Права доступа:** Убедитесь, что директория `uploads/vocabulary/` имеет права записи

3. **Безопасность:** Система уже включает базовые проверки безопасности, но рекомендуется дополнительно настроить веб-сервер для блокировки выполнения скриптов в директории uploads

4. **Мониторинг:** Отслеживайте размер директории uploads и при необходимости реализуйте систему очистки неиспользуемых изображений

## Расширение системы

Для добавления поддержки других типов файлов или изменения ограничений:

1. Обновите константы в `UploadConfig`
2. Добавьте соответствующие ключи переводов
3. Обновите клиентскую валидацию в JavaScript
4. Протестируйте изменения

Система спроектирована модульно и легко расширяется для поддержки дополнительных типов загрузок.
